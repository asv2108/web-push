<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="manifest" href="manifest.json">
    <script src="firebase/firebase.js"></script>
    <script src="jquery-2.2.1.min.js"></script>
    <title>Firebase Cloud Messaging</title>

</head>
<body>
<main class="" id="">
    <div id="token_div">
        <h4>Instance ID Token</h4>
        <p id="token"></p>
        <button class=""
                onclick="deleteToken()">Delete Token
        </button>
    </div>

    <div id="permission_div">
        <h4>Needs Permission</h4>
        <p id="token2"></p>
        <button class="" onclick="subscribe()">Request Permission</button>
    </div>
    <div id="messages"></div>

    <div>
        <form action="send.php" method="post">
            <label>Title</label>
            <input type="text"name="title'">
            <label>Body</label>
            <input type="text"name="body">
            <!--<button type="button" onclick="sendMyNotification()">-->
                <!--Send-->
            <!--</button>-->
            <input type= "submit" value= "Отправить">
        </form>
    </div>
</main>
</body>
</html>
<script>
    //перенес from messaging-sw
    var config = {
        apiKey: "AIzaSyBaaV8jUe_6oHafyAHLGiN2uO-Tfi7bFcg",
        authDomain: "vasilyev-e6d1e.firebaseapp.com",
        databaseURL: "https://vasilyev-e6d1e.firebaseio.com",
        projectId: "vasilyev-e6d1e",
        storageBucket: "",
        messagingSenderId: "709625869743"
    };
    firebase.initializeApp(config);

    const messaging = firebase.messaging();

    messaging.usePublicVapidKey("BC38NtDGBrwHcy3rELmRwA4whdxaRXGaKHzAxOAfWwbhobsgBLzbVXgfkztXfFi2zX-c14IOwPsUaKiQjfdE49I");

    // function sendMyNotification() {
    //      //TODO проверка полей
    //
    // }


    // onTokenRefresh  вызывается только при создании нового токена.
    // Если ваше приложение было ранее установлено и сгенерировано токен,
    // то onTokenRefresh не будет вызываться. Попробуйте удалить и переустановить приложение,
    // чтобы заставить генерировать новый токен, это вызовет вызов onTokenRefresh.
    // messaging.onTokenRefresh(function () {
    //     messaging.getToken()
    //         .then(function (refreshedToken) {
    //             console.log('Token refreshed.');
    //             showToken('refresh AAAAAAAAAAAAAAA    '+ refreshedToken);
    //             alert('refresh');
    //         })
    //         .catch(function (err) {
    //             console.log('Unable to retrieve refreshed token ', err);
    //             alert('Проблема с ключем регистрации усьройства');
    //         });
    // });

    messaging.requestPermission().then(function () {
        messaging.getToken()
            .then(function (currentToken) {
                showToken(currentToken + ' request permission');
                window.localStorage.setItem('isToken', '1');
            }).catch(function (err) {
            console.log(err);
        })
    }).catch(function (err) {
        alert('You need put on web notification in your browser!');
        console.log(err);
    });


    // отображаем на сайте, если он не свернут?
    // messaging.onMessage(function (payload) {
    //     console.log("Message received. ", payload);
    //     appendMessage(payload);
    // });

    function subscribe() {
        messaging.getToken()
            .then(function (currentToken) {
                if (currentToken) {
                    // внешнее отображение
                    console.log(currentToken);
                    showToken(currentToken);
                    // сохранение токена в бд
                    sendTokenToServer(currentToken,'set');
                } else {
                    // Show permission request.
                    console.log('No Instance ID token available. Request permission to generate one.');
                }
            })
            .catch(function (err) {
                console.log('An error occurred while retrieving token. ', err);
                showToken('Error retrieving Instance ID token. ', err);
            })
    }


    //выводим кюч подписанного устройства ставим флаг что что ключ сброшен
    function showToken(currentToken) {
        var tokenElement = document.querySelector('#token');
        tokenElement.textContent = currentToken;
    }

    function deleteToken() {
        messaging.getToken()
            .then(function (currentToken) {
                messaging.deleteToken(currentToken)
                    .then(function () {
                        console.log('Token deleted.');
                        // убиваем ключ в бд
                        sendTokenToServer(currentToken,'delete');
                    })
                    .catch(function (err) {
                        console.log('Unable to delete token. ', err);
                    });
            })
            .catch(function (err) {
                console.log('Error retrieving Instance ID token. ', err);
                showToken('Error retrieving Instance ID token. ', err);
            });
    }

    function sendTokenToServer(currentToken,type) {
        // TODO(developer): Send the current token to your server.

    }


    // Add a message to the messages element.
    function appendMessage(payload) {
        const messagesElement = document.querySelector('#messages');
        const dataHeaderELement = document.createElement('h5');
        const dataElement = document.createElement('pre');
        dataElement.style = 'overflow-x:hidden;';
        dataHeaderELement.textContent = 'Received message:';
        dataElement.textContent = JSON.stringify(payload, null, 2);
        messagesElement.appendChild(dataHeaderELement);
        messagesElement.appendChild(dataElement);
    }


</script>
